package main

import (
	"fmt"
	"io"
	"os"
	"time"
)

var blockSize = 8192

func splitToBlocks(buf []byte) [][]byte {
	var res [][]byte

	for i := 0; i < int(len(buf)/blockSize); i++ {
		res = append(res, buf[i*blockSize:i*blockSize+blockSize])
	}

	// TODO check if it will not produce bug
	// OR maybe need to fill it with zeros
	// if len(buf)%blockSize != 0 {
	// 	res = append(res, buf[len(res)*blockSize:])
	// }

	return res
}

// func getMaxSimilarity() {

// }

// [76 111 114 101 109 32  105 112 115 117 109 44 32 100 111 108]
// [32 105 112 115 97  109 32  97  110 105 109 105 32 110 97 109]
// [13 10  97  99  99  117 115 97  109 117 115 44 32 118 111 108]

func checkBlocksSolidity(a []byte, b []byte) int {
	solidity := 0
	similarity := 0

	for i := 0; i < len(a); i++ {
		if a[i] == b[i] {
			similarity++

			if similarity > solidity {
				solidity = similarity
			}
		} else {
			similarity = 0
		}
	}

	return solidity
}

func currentTime() string {
	return time.Now().Local().Format("2006-01-02 15:04:05")
}

func main() {
	fmt.Println("# OPEN FILE", currentTime())

	file, _ := os.Open("C:/Users/User/Downloads/Dev.tar")
	// file, _ := os.Open("./assets/test.txt")
	defer file.Close()

	buffer := make([]byte, 1024*1024*1024)
	// fileStat, _ := file.Stat()

	// Block to find
	// var refBlock []byte
	// refBlockMaxSize := fileStat.Size() / 2

	for {
		fmt.Println("# READ FILE", currentTime())

		bytesNum, err := file.Read(buffer)

		if err == io.EOF {
			break
		}

		// TODO check all sizes
		// mostEffectiveSize := 0

		// for size := 0; size < int(refBlockMaxSize); size++ {
		fmt.Println("# SPLIT BLOCKS", currentTime())

		blocks := splitToBlocks(buffer[:bytesNum])

		fmt.Println("# CHECK SOLIDITY", currentTime())

		for i := 0; i < len(blocks)-1; i++ {
			for j := i + 1; j < len(blocks); j++ {
				solidity := checkBlocksSolidity(blocks[i], blocks[j])

				if solidity >= 8 {
					// fmt.Println("REF_BLOCK", blocks[i])
					// fmt.Println("\tCHECK_BLOCK", solidity, "\t", blocks[j][:16])
				}
			}
		}
		// }

		// fmt.Println(refBlock, buffer[:bytesNum][i*blockSize+blockSize:])

		// break

		// fmt.Println(blockSimilarity(buffer[:bytesNum][:blockSize], refBlock))
		// if bytes.Count(buffer[:bytesNum], refBlock) >= 2 {
		// 	fmt.Println(len(refBlock), refBlock)
		// }

		// refBlockWithOffset := refBlock[:len(refBlock)-i]

		// if bytes.Count(buffer[:bytesNum], refBlockWithOffset) >= 2 {
		// 	deleteIndex := bytes.LastIndex(buffer[:bytesNum], refBlockWithOffset)
		// 	before, after, _ := bytes.Cut(buffer[:bytesNum], refBlockWithOffset)

		// 	buffer = append(before, after...)

		// 	// fmt.Println(refBlockWithOffset, deleteIndex)
		// 	fmt.Println(deleteIndex, buffer, len(buffer))

		// 	break
		// }
		// }
	}
}

// [76 111 114 101 109 32 105 112 115 117 109 44 32 100 111 108 111 114 32 115 105 116 32 97 109 101 116 32 99 111 110 115 101 99 116 101 116 117 114 32 97 100 105 112 105 115 105 99 105 110 103 32 101 108 105 116 46 32 83 101 100 32 99 111 110 115 101 99 116 101 116 117 114 32 100 101 115 101 114 117 110 116 32 115 97 101 112 101 32 116 101 109 112 111 114 97 32 105 112 115 97 109 32 97 110 105 109 105 32 110 97 109 13 10 97 99 99 117 115 97 109 117 115 44 32 118 111 108 117 112 116 97 116 101 109 32 110 101 113 117 101 44 32 113 117 105 32 97 108 105 113 117 105 100 32 111 100 105 111 32 101 120 112 108 105 99 97 98 111 32 99 111 114 112 111 114 105 115 32 105 108 108 117 109 32 111 112 116 105 111 32 111 102 102 105 99 105 97 32 101 120 112 101 100 105 116 97 32 118 111 108 117 112 116 97 116 117 109 32 100 111 108 111 114 101 32 118 111 108 117 112 116 97 115 13 10 105 117 115 116 111 32 115 105 116 32 101 108 105 103 101 110 100 105 44 32 99 117 109 113 117 101 32 113 117 97 115 105 32 101 117 109 46 32 82 101 99 117 115 97 110 100 97 101 32 114 101 114 117 109 32 109 97 103 110 105 32 110 105 115 105 32 117 108 108 97 109 32 98 101 97 116 97 101 32 109 111 100 105 44 32 99 111 114 114 117 112 116 105 44 32 113 117 111 115 32 105 100 32 112 114 97 101 115 101 110 116 105 117 109 32 118 101 114 111 13 10 100 111 108 111 114 101 115 44 32 105 110 32 118 111 108 117 112 116 97 116 117 109 32 105 108 108 117 109 32 115 105 116 46 32 79 100 105 116 32 118 101 108 32 110 105 115 105 32 97 100 105 112 105 115 99 105 32 116 101 110 101 116 117 114 44 32 118 111 108 117 112 116 97 116 101 115 32 102 117 103 105 97 116 32 101 120 44 32 101 115 115 101 32 100 111 108 111 114 101 109 113 117 101 32 118 101 114 105 116 97 116 105 115 13 10 99 117 112 105 100 105 116 97 116 101 32 113 117 105 98 117 115 100 97 109 32 111 102 102 105 99 105 105 115 32 109 97 105 111 114 101 115 32 101 120 101 114 99 105 116 97 116 105 111 110 101 109 32 115 101 100 32 101 115 116 32 105 110 33 32 65 114 99 104 105 116 101 99 116 111 32 105 115 116 101 32 101 97 114 117 109 32 114 101 112 101 108 108 97 116 32 101 120 32 101 97 32 113 117 97 109 32 101 111 115 13 10 112 114 97 101 115 101 110 116 105 117 109 32 109 97 120 105 109 101 32 109 97 105 111 114 101 115 32 110 105 104 105 108 32 101 120 112 101 100 105 116 97 32 101 110 105 109 32 114 101 112 101 108 108 101 110 100 117 115 32 108 97 117 100 97 110 116 105 117 109 32 108 97 98 111 114 117 109 32 114 101 109 32 97 110 105 109 105 32 97 100 44 32 109 111 108 108 105 116 105 97 32 116 101 109 112 111 114 101 32 110 111 98 105 115 13 10 100 117 99 105 109 117 115 32 114 101 114 117 109 32 105 109 112 101 100 105 116 32 100 101 108 101 110 105 116 105 46 57 57 57 57 57 76 111 114 101 109 32 105 112 115 117 109 44 32 100 111 108 111 114 32 115 105 116 32 97 109 101 116 32 99 111 110 115 101 99 116 101 116 117 114 32 97 100 105 112 105 115 105 99 105 110 103 32 101 108 105 116 46 32 83 101 100 32 99 111 110 115 101 99 116 101 116 117 114 32 100 101 115 101 114 117 110 116 13 10 115 97 101 112 101 32 116 101 109 112 111 114 97 32 105 112 115 97 109 32 97 110 105 109 105 32 110 97 109 32 97 99 99 117 115 97 109 117 115 44 32 118 111 108 117 112 116 97 116 101 109 32 110 101 113 117 101 44 32 113 117 105 32 97 108 105 113 117 105 100 32 111 100 105 111 32 101 120 112 108 105 99 97 98 111 32 99 111 114 112 111 114 105 115 32 105 108 108 117 109 32 111 112 116 105 111 32 111 102 102 105 99 105 97 13 10 101 120 112 101 100 105 116 97 32 118 111 108 117 112 116 97 116 117 109 32 100 111 108 111 114 101 32 118 111 108 117 112 116 97 115 32 105 117 115 116 111 32 115 105 116 32 101 108 105 103 101 110 100 105 44 32 99 117 109 113 117 101 32 113 117 97 115 105 32 101 117 109 46 32 82 101 99 117 115 97 110 100 97 101 32 114 101 114 117 109 32 109 97 103 110 105 32 110 105 115 105 32 117 108 108 97 109 32 98 101 97 116 97 101 32 109 111 100 105 44 13 10 99 111 114 114 117 112 116 105 44 32 113 117 111 115 32 105 100 32 112 114 97 101 115 101 110 116 105 117 109 32 118 101 114 111 32 100 111 108 111 114 101 115 44 32 105 110 32 118 111 108 117 112 116 97 116 117 109 32 105 108 108 117 109 32 115 105 116 46 32 79 100 105 116 32 118 101 108 32 110 105 115 105 32 97 100 105 112 105 115 99 105 32 116 101 110 101 116 117 114 44 32 118 111 108 117 112 116 97 116 101 115 32 102 117 103 105 97 116 13 10 101 120 44 32 101 115 115 101 32 100 111 108 111 114 101 109 113 117 101 32 118 101 114 105 116 97 116 105 115 32 99 117 112 105 100 105 116 97 116 101 32 113 117 105 98 117 115 100 97 109 32 111 102 102 105 99 105 105 115 32 109 97 105 111 114 101 115 32 101 120 101 114 99 105 116 97 116 105 111 110 101 109 32 115 101 100 32 101 115 116 32 105 110 33 32 65 114 99 104 105 116 101 99 116 111 32 105 115 116 101 32 101 97 114 117 109 13 10 114 101 112 101 108 108 97 116 32 101 120 32 101 97 32 113 117 97 109 32 101 111 115 32 112 114 97 101 115 101 110 116 105 117 109 32 109 97 120 105 109 101 32 109 97 105 111 114 101 115 32 110 105 104 105 108 32 101 120 112 101 100 105 116 97 32 101 110 105 109 32 114 101 112 101 108 108 101 110 100 117 115 32 108 97 117 100 97 110 116 105 117 109 32 108 97 98 111 114 117 109 32 114 101 109 32 97 110 105 109 105 32 97 100 44 13 10 109 111 108 108 105 116 105 97 32 116 101 109 112 111 114 101 32 110 111 98 105 115 32 100 117 99 105 109 117 115 32 114 101 114 117 109 32 105 109 112 101 100 105 116 32 100 101 108 101 110 105 116 105 46]

// [32 13 10 13 10 32 13 10 32 13 10 32 13 10 32 13 10 57 57 57 57 57 76 111 114 101 109 32 105 112 115 117 109 44 32 100 111 108 111 114 32 115 105 116 32 97 109 101 116 32 99 111 110 115 101 99 116 101 116 117 114 32 97 100 105 112 105 115 105 99 105 110 103 32 101 108 105 116 46 32 83 101 100 32 99 111 110 115 101 99 116 101 116 117 114 32 100 101 115 101 114 117 110 116 13 10 115 97 101 112 101 32 116 101 109 112 111 114 97 32 105 112 115 97 109 32 97 110 105 109 105 32 110 97 109 32 97 99 99 117 115 97 109 117 115 44 32 118 111 108 117 112 116 97 116 101 109 32 110 101 113 117 101 44 32 113 117 105 32 97 108 105 113 117 105 100 32 111 100 105 111 32 101 120 112 108 105 99 97 98 111 32 99 111 114 112 111 114 105 115 32 105 108 108 117 109 32 111 112 116 105 111 32 111 102 102 105 99 105 97 13 10 101 120 112 101 100 105 116 97 32 118 111 108 117 112 116 97 116 117 109 32 100 111 108 111 114 101 32 118 111 108 117 112 116 97 115 32 105 117 115 116 111 32 115 105 116 32 101 108 105 103 101 110 100 105 44 32 99 117 109 113 117 101 32 113 117 97 115 105 32 101 117 109 46 32 82 101 99 117 115 97 110 100 97 101 32 114 101 114 117 109 32 109 97 103 110 105 32 110 105 115 105 32 117 108 108 97 109 32 98 101 97 116 97 101 32 109 111 100 105 44 13 10 99 111 114 114 117 112 116 105 44 32 113 117 111 115 32 105 100 32 112 114 97 101 115 101 110 116 105 117 109 32 118 101 114 111 32 100 111 108 111 114 101 115 44 32 105 110 32 118 111 108 117 112 116 97 116 117 109 32 105 108 108 117 109 32 115 105 116 46 32 79 100 105 116 32 118 101 108 32 110 105 115 105 32 97 100 105 112 105 115 99 105 32 116 101 110 101 116 117 114 44 32 118 111 108 117 112 116 97 116 101 115 32 102 117 103 105 97 116 13 10 101 120 44 32 101 115 115 101 32 100 111 108 111 114 101 109 113 117 101 32 118 101 114 105 116 97 116 105 115 32 99 117 112 105 100 105 116 97 116 101 32 113 117 105 98 117 115 100 97 109 32 111 102 102 105 99 105 105 115 32 109 97 105 111 114 101 115 32 101 120 101 114 99 105 116 97 116 105 111 110 101 109 32 115 101 100 32 101 115 116 32 105 110 33 32 65 114 99 104 105 116 101 99 116 111 32 105 115 116 101 32 101 97 114 117 109 13 10 114 101 112 101 108 108 97 116 32 101 120 32 101 97 32 113 117 97 109 32 101 111 115 32 112 114 97 101 115 101 110 116 105 117 109 32 109 97 120 105 109 101 32 109 97 105 111 114 101 115 32 110 105 104 105 108 32 101 120 112 101 100 105 116 97 32 101 110 105 109 32 114 101 112 101 108 108 101 110 100 117 115 32 108 97 117 100 97 110 116 105 117 109 32 108 97 98 111 114 117 109 32 114 101 109 32 97 110 105 109 105 32 97 100 44 13 10 109 111 108 108 105 116 105 97 32 116 101 109 112 111 114 101 32 110 111 98 105 115 32 100 117 99 105 109 117 115 32 114 101 114 117 109 32 105 109 112 101 100 105 116 32 100 101 108 101 110 105 116 105 46]
